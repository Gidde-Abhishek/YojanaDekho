# .github/workflows/deploy.yml
name: Deploy React Frontend

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm ci
        npm install -D canvas    # Install canvas for tests
        
    - name: Create Test Setup
      run: |
        mkdir -p src/__mocks__
        echo "const Lottie = () => null; export default Lottie;" > src/__mocks__/react-lottie.js
        
    - name: Build
      run: npm run build
      env:
        CI: false  # Prevents treating warnings as errors
        
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        echo "13.234.33.4 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCroDMJBI8rj2Vpy70nF0lJTgXXeCwjU1f5QULyLboyPGS1DO0FYcuV27W7lLA7xNGwheIk+z8cPZ87u6nfTDM+H7HYDwqdGJfmM64qTZWAkAqWHS3wqMsuElgGwdiUxTwTcUa7klawHQCEMAoyMW6onWUDeA2rIsw60p3HwjCyjZXhbSMLo/Xgaz/Ss09YMSnAtn4ME8b2F38Is/KGo4xPzFZt6pIw7gMm7u9nW/drCVTXhVAtK64Mxw61GSYM20cdDVXSMQKIAzCvYem76w9/+a/uBFU4PRJ9SY/tm/VwDmmqyWC8cFUHJ65ZLvffasi8Yl+Y3gh4h8nMTpBnXFaiquDQBYs4IY+JgpnyXoTi4ZOofRL5CE2K1qz6zK9xyPnsJqPFJaYisASfmh9jcf384kZAN07PDD8wFIhCLFTyaTBei34qxxEstlZfbBSAiWtAExWVjfFZg6v0EPmAEoGSaO1/oC5I6cig9At8+fvv4hMitfeJ07fNt+ZidHkydyM=" >> ~/.ssh/known_hosts
        
    - name: Deploy to Server
      run: |
        # Backup existing deployment
        ssh -i ~/.ssh/deploy_key developer@13.234.33.4 "if [ -d /var/www/html/schemefinder.arthnirmiti.com ]; then tar -czf ~/backup-\$(date +%Y%m%d_%H%M%S).tar.gz -C /var/www/html schemefinder.arthnirmiti.com; fi"
        
        # Deploy new version
        rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key" \
          build/ developer@13.234.33.4:/var/www/html/schemefinder.arthnirmiti.com/

    - name: Post-deployment tasks
      run: |
        # Clear browser caches by updating cache busting query parameter
        ssh -i ~/.ssh/deploy_key developer@13.234.33.4 "cd /var/www/html/schemefinder.arthnirmiti.com && find . -type f -name '*.js' -o -name '*.css' | xargs -I {} sh -c 'mv {} {}.tmp && mv {}.tmp {}'"